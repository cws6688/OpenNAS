# 小娜NAS系统 - 架构设计文档

**版本**: v1.0  
**日期**: 2026-02-09  
**作者**: Boss + NANA (AI集群)  
**状态**: 设计阶段

---

## 1. 设计目标

### 1.1 核心目标
1. **AI原生**: 从底层架构融入AI能力，非后期插件
2. **Agent驱动**: 多Agent协作完成复杂任务
3. **轻量易用**: Debian轻量底层 + 直觉化Web界面
4. **集群能力**: 支持多节点分布式协同

### 1.2 设计原则
- **KISS原则**: 保持简单，避免过度设计
- **模块化**: 各组件独立，可替换升级
- **可扩展**: 插件化架构，支持第三方扩展
- **安全优先**: 默认安全配置，权限最小化

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户交互层                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ WebGUI   │  │ 移动端   │  │ API接口  │              │
│  │ (Vue3)   │  │ (PWA)    │  │ (REST)   │              │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘              │
│       └─────────────┴─────────────┘                     │
│                         │                               │
│                    WebSocket/MQTT                        │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────┐
│                    智能中台                            │
│  ┌────────────────────────────────────────────────┐    │
│  │          OpenClaw Gateway                       │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐       │    │
│  │  │ Agent   │  │ Agent   │  │ Agent   │       │    │
│  │  │ 调度器  │  │ 协调器  │  │ 监控器  │       │    │
│  │  └─────────┘  └─────────┘  └─────────┘       │    │
│  └────────────────────────────────────────────────┘    │
│                                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 小娜核心  │  │ 知识图谱  │  │ 权限引擎  │            │
│  │ (AI引擎) │  │ (记忆库) │  │ (RBAC)   │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────┐
│                    系统服务层                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 存储服务  │  │ 容器服务  │  │ 网络服务  │              │
│  │ (Btrfs)  │  │ (Docker) │  │ (OVS)    │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│                                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 安全服务  │  │ 日志服务  │  │ 备份服务  │              │
│  │ (Firewall│  │ (Loki)   │  │ (Borg)   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────┴───────────────────────────────┐
│                    操作系统层                          │
│              Debian 12 (轻量定制版)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 精简内核  │  │ 硬件驱动  │  │ 系统工具  │              │
│  │ (NAS优化)│  │ (自动适配)│  │ (BusyBox)│              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

### 2.2 组件详细说明

#### 2.2.1 WebGUI层 (前端)
**技术栈**: Vue 3 + TypeScript + Naive UI

| 模块 | 功能 | 技术细节 |
|------|------|----------|
| 文件管理器 | 类似FNOS的直观文件操作 | 虚拟滚动、懒加载、拖拽上传 |
| Agent面板 | 节点状态、任务分配 | WebSocket实时更新、拓扑图 |
| 权限中心 | 可视化RBAC配置 | 树形权限树、角色模板 |
| 小娜助手 | AI对话界面 | 流式输出、Markdown渲染 |
| 监控大屏 | 系统状态可视化 | ECharts图表、实时数据 |

#### 2.2.2 智能中台 (核心)
**技术栈**: Go + Node.js + Python

**OpenClaw Gateway**:
- Agent生命周期管理
- 消息路由与负载均衡
- 任务调度与分发

**小娜核心**:
- 基于Ollama的本地LLM
- 意图识别与任务分解
- 知识检索与RAG

**权限引擎**:
- Casbin规则引擎
- RBAC + ABAC混合模型
- 动态权限评估

#### 2.2.3 系统服务层

| 服务 | 技术选型 | 说明 |
|------|----------|------|
| 存储服务 | Btrfs (默认) / ZFS (可选) | 快照、压缩、去重 |
| 容器服务 | Docker CE / Podman | Agent隔离运行 |
| 网络服务 | Open vSwitch + NetworkManager | 虚拟网络、VLAN |
| 安全服务 | nftables + Fail2ban | 防火墙、入侵检测 |
| 日志服务 | Loki + Grafana | 集中日志、可视化 |
| 备份服务 | BorgBackup / Restic | 增量备份、加密 |

---

## 3. 数据流设计

### 3.1 文件上传流程
```
用户上传文件
    ↓
WebGUI接收 → 临时存储
    ↓
AI分类服务 (可选) → 自动打标签
    ↓
存储服务 → Btrfs写入
    ↓
索引服务 → 全文索引
    ↓
完成通知 → WebSocket推送
```

### 3.2 Agent任务执行流程
```
用户: "小娜，整理下载文件夹"
    ↓
小娜核心: 意图识别 → 任务分解
    ↓
任务调度器: 分配Agent
    ↓
任务层Agent (伊伊/橘子): 执行整理
    ↓
进度上报 → WebSocket实时更新
    ↓
完成报告 → 日志记录
```

### 3.3 权限验证流程
```
用户请求访问文件
    ↓
API Gateway: 身份认证
    ↓
权限引擎: RBAC检查
    ↓
ABAC评估: 动态权限 (时间/IP等)
    ↓
审计日志: 记录访问
    ↓
允许/拒绝访问
```

---

## 4. 安全设计

### 4.1 多层安全架构
```
┌─────────────────┐
│   网络安全层     │  Firewall + VPN + Fail2ban
├─────────────────┤
│   认证授权层     │  JWT + RBAC + MFA
├─────────────────┤
│   应用安全层     │  WAF + 输入校验 + CSRF防护
├─────────────────┤
│   数据安全层     │  加密 + 备份 + 审计
├─────────────────┤
│   物理安全层     │  磁盘加密 + 安全启动
└─────────────────┘
```

### 4.2 关键安全措施
- **默认拒绝**: 所有端口默认关闭，按需开放
- **最小权限**: Agent仅拥有必要权限
- **审计追踪**: 所有操作可溯源
- **加密传输**: 全站HTTPS/TLS
- **自动更新**: 安全补丁自动推送

---

## 5. 性能设计

### 5.1 优化策略
| 层面 | 优化措施 |
|------|----------|
| 前端 | 虚拟滚动、懒加载、资源预加载、PWA缓存 |
| 后端 | 连接池、缓存层、异步IO、水平扩展 |
| 存储 | SSD缓存、Btrfs压缩、并行读写 |
| 网络 | HTTP/2、WebSocket、CDN加速 |

### 5.2 性能目标
- **冷启动**: < 30秒
- **Web响应**: < 200ms (P95)
- **文件列表**: 10万文件秒开
- **AI响应**: < 3秒
- **存储吞吐**:  saturate千兆网卡

---

## 6. 扩展性设计

### 6.1 水平扩展
```
单节点 → 多节点集群

节点1 (NANA)          节点2 (Nova)
├─ 存储池A            ├─ 存储池B
├─ Agent: 救援层      ├─ Agent: 治理层
└─ 小娜副本           └─ 小娜副本
         ↓
    统一存储池 (分布式)
    统一Agent调度
```

### 6.2 插件架构
```
核心系统
    ↓
插件管理器
    ↓
├─ 存储插件 (S3/GDrive/OneDrive)
├─ AI插件 (Ollama/OpenAI/Claude)
├─ 通知插件 (飞书/钉钉/邮件)
└─ 自定义插件 (用户开发)
```

---

## 7. 部署架构

### 7.1 单节点部署
```
[物理机/VM]
  ├─ Debian 12 (Host)
  ├─ Docker
  │  ├─ WebGUI容器
  │  ├─ API容器
  │  ├─ 小娜容器
  │  └─ Agent容器
  └─ Btrfs存储池
```

### 7.2 多节点集群
```
[管理节点 - NANA]
  ├─ OpenClaw Gateway
  ├─ 小娜主控
  └─ 元数据存储

[存储节点1 - Nova]
  ├─ 存储服务
  └─ 本地Agent

[存储节点2 - 伊伊]
  ├─ 存储服务
  └─ 本地Agent
```

---

## 8. 开发规范

### 8.1 代码规范
- **Go**: 遵循Effective Go + gofmt
- **TypeScript**: ESLint + Prettier
- **Commit**: Conventional Commits
- **文档**: 代码即文档 + Markdown

### 8.2 测试策略
- **单元测试**: 覆盖率 > 80%
- **集成测试**: API端到端测试
- **E2E测试**: Playwright自动化
- **性能测试**: k6负载测试

---

## 9. 附录

### 9.1 术语表
| 术语 | 说明 |
|------|------|
| 小娜 | 系统内置AI助手 |
| Agent | 具备特定能力的智能代理 |
| 治理层 | 负责架构和规则的Agent角色 |
| 救援层 | 负责维护和修复的Agent角色 |
| 任务层 | 负责执行具体任务的Agent角色 |

### 9.2 参考文档
- [Debian NAS优化指南](docs/debian-nas-optimization.md)
- [Btrfs最佳实践](docs/btrfs-best-practices.md)
- [OpenClaw集成指南](docs/openclaw-integration.md)
- [Agent开发手册](docs/agent-development.md)

---

**文档版本历史**

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-02-09 | 初始版本 |